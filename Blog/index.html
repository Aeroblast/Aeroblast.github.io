<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <META HTTP-EQUIV="expires" CONTENT="0">
    <title>AE在Github Page上的Blog</title>
    <style>
        body {
            background: #101010;
            color: antiquewhite;
        }

        #toc>div:hover {
            background: #303030;
        }

        #toc>div {
            border-bottom: #660000 solid 2px;
            white-space: nowrap;
            overflow-x: scroll;
            padding-top: 0.2em;
            padding-bottom: 0.2em;
            background: #101010;
        }

        #toc>div::-webkit-scrollbar {
            display: none;
        }

        #toc {
            overflow: scroll;
        }

        #toc::-webkit-scrollbar {
            display: none;
        }

        *[selected="false"] {
            display: none;
        }
    </style>
</head>

<body>
    <div style="-webkit-overflow-scrolling:touch; overflow-x:hidden;width:75%;position:fixed;left:20%;height:98%;">
        <iframe src="" id="mainwin" style="width: 100%;height: 100%;border: 0 none;overflow-x:hidden;"></iframe>
    </div>
    <div id="toc"
        style="position:fixed;width: 18%;left: 2%;height:100%;border-right: 1px solid brown;background:rgba(0,0,0,0.5)">
        这里应该是目录……
    </div>
    <div style="position:fixed;width: 18%;left: 2%;height:2em;bottom: 0;border-top: 1px solid brown;border-right: 1px solid brown"
        onclick="ListShift()">
        <p id="ListShiftButton" style="text-align: center;cursor: pointer;font-weight: bold;margin: 0;">展开</p>
    </div>
    <script src="util.js"></script>
    <script>

        var mainwin = document.getElementById("mainwin");
        var index = new Array();
        var loader = new XMLHttpRequest();
        var toc = document.getElementById('toc');

        var query_tag_string = "&tags=" + GetQueryString("tags");
        var query_tags = (GetQueryString("tags")||",").split(",");
        if (query_tags.length == 1 && query_tags[0] == "") query_tag_string = "";

        loader.open('GET', "index.txt?" + RandomQuery(), true);
        loader.onreadystatechange = LoadIndex;
        loader.send(null);

        /////////////Main//////////////
        //LoadIndex()-LoadQuery()

        function LoadIndex() {
            if (loader.readyState == 4)
                if (loader.status == 200) {
                    let toc_index = loader.responseText.split("\n");
                    var s = "";
                    toc_index.forEach(element => {
                        s += ReadIndex(element);
                    });
                    toc.innerHTML = s;
                    LoadDoc();
                }
        }
        function ReloadIndex() {

        }
        function LoadDoc() {
            let n = GetQueryString("n");
            if (n != null)
                if (n.length > 1) {
                    mainwin.src = "viewer.html?n=" + n + "&" + RandomQuery();
                    return;
                }
            mainwin.src = "viewer.html?n=welcome";
        }

        var list_state = 0;
        var list_shift_button = document.getElementById("ListShiftButton");
        function ListShift() {
            if (list_state == 0) {
                list_state = 1; toc.style.width = "90%"; list_shift_button.innerText = "缩小";
            } else if (list_state == 1) {
                list_state = 0; toc.style.width = "18%"; list_shift_button.innerText = "展开";
            }

        }

        ////////////////helpers/////////////
        function LoadBlog(i) {
            let i_n = parseInt(i);
            let name = index[i_n][0];
            mainwin.onloadend = function () { mainwin.contentDocument.getElementById("info").innerHTML = index[i_n]; }
            mainwin.src = "viewer.html?n=" + name + "&" + RandomQuery();
            history.pushState({}, index[i_n][1], location.pathname + "?n=" + name + query_tag_string);
        }
        function IsInQueryTags(s) {
            if (s == "") return false;
            for (let i = 0; i < query_tags.length; i++) {
                if (query_tags[i] != "" && query_tags[i] == s) return true;
            }
            return false;
        }
        function ReadIndex(element) {
            let es = element.split(',');
            let r = "";
            let select = "false";
            for (let i = 2; i < es.length; i++) {//Tags check
                if (IsInQueryTags(es[i])) {
                    select = "true";
                }
            }
            select = " selected=\"" + select + "\"";
            if (es.length > 1 && es[1].length > 0) {
                r = "<div onclick=\"LoadBlog('" + index.length + "')" + select + "\">" + es[1] + "</div>"
            }
            else {
                es.push(es[0]);
                r = "<div onclick=\"LoadBlog('" + index.length + "')" + select + "\">" + es[0] + "</div>"
            }
            index.push(es);
            return r;
        }
    </script>
</body>

</html>